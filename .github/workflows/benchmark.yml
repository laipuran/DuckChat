name: Performance Benchmark

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev libsqlite3-dev libncursesw5-dev build-essential time bc
        
    - name: Build debug version
      run: |
        echo "=== 构建调试版本 ==="
        ./build.sh clean
        ./build.sh all
        
    - name: Build optimized version
      run: |
        echo "=== 构建优化版本 ==="
        # 创建性能测试配置
        cp config.sh config_perf.sh
        sed -i 's/CXXFLAGS="-g3 -O0/CXXFLAGS="-O3 -DNDEBUG -march=native/' config_perf.sh
        sed -i 's/include config.sh/include config_perf.sh/' build.sh
        ./build.sh clean
        ./build.sh all
        
        # 备份优化版本
        cp server/server server/server_optimized
        cp client/client client/client_optimized
        
    - name: Restore debug version
      run: |
        # 恢复调试版本
        sed -i 's/include config_perf.sh/include config.sh/' build.sh
        ./build.sh clean
        ./build.sh all
        
    - name: Compile time benchmark
      run: |
        echo "=== 编译时间基准测试 ==="
        
        # 测试调试版本编译时间
        echo "调试版本编译时间:"
        time_result_debug=$(time (./build.sh clean && ./build.sh all) 2>&1 | grep real | awk '{print $2}')
        echo "Debug: $time_result_debug"
        
        # 测试优化版本编译时间
        echo "优化版本编译时间:"
        sed -i 's/include config.sh/include config_perf.sh/' build.sh
        time_result_opt=$(time (./build.sh clean && ./build.sh all) 2>&1 | grep real | awk '{print $2}')
        echo "Optimized: $time_result_opt"
        
        # 恢复调试版本
        sed -i 's/include config_perf.sh/include config.sh/' build.sh
        ./build.sh clean
        ./build.sh all
        
    - name: Startup time benchmark
      run: |
        echo "=== 启动时间基准测试 ==="
        
        # 测试调试版本启动时间
        echo "调试版本启动时间:"
        for i in {1..5}; do
          timeout 5s time ./server/server &
          SERVER_PID=$!
          sleep 1
          kill $SERVER_PID 2>/dev/null || true
        done
        
        # 测试优化版本启动时间
        echo "优化版本启动时间:"
        for i in {1..5}; do
          timeout 5s time ./server/server_optimized &
          SERVER_PID=$!
          sleep 1
          kill $SERVER_PID 2>/dev/null || true
        done
        
    - name: Memory usage benchmark
      run: |
        echo "=== 内存使用基准测试 ==="
        
        # 测试调试版本内存使用
        echo "调试版本内存使用:"
        timeout 10s ./server/server &
        SERVER_PID=$!
        sleep 2
        
        if kill -0 $SERVER_PID 2>/dev/null; then
          ps -p $SERVER_PID -o pid,vsz,rss,comm || true
          kill $SERVER_PID 2>/dev/null || true
        fi
        
        # 测试优化版本内存使用
        echo "优化版本内存使用:"
        timeout 10s ./server/server_optimized &
        SERVER_PID=$!
        sleep 2
        
        if kill -0 $SERVER_PID 2>/dev/null; then
          ps -p $SERVER_PID -o pid,vsz,rss,comm || true
          kill $SERVER_PID 2>/dev/null || true
        fi
        
    - name: Binary size comparison
      run: |
        echo "=== 二进制大小对比 ==="
        
        echo "调试版本二进制大小:"
        ls -lh server/server client/client
        
        echo "优化版本二进制大小:"
        ls -lh server/server_optimized client/client_optimized
        
        # 计算大小差异
        debug_size=$(stat -c%s server/server)
        opt_size=$(stat -c%s server/server_optimized)
        reduction=$((debug_size - opt_size))
        reduction_percent=$((reduction * 100 / debug_size))
        
        echo "服务器二进制大小减少: $reduction bytes ($reduction_percent%)"
        
        debug_size=$(stat -c%s client/client)
        opt_size=$(stat -c%s client/client_optimized)
        reduction=$((debug_size - opt_size))
        reduction_percent=$((reduction * 100 / debug_size))
        
        echo "客户端二进制大小减少: $reduction bytes ($reduction_percent%)"
        
    - name: Cleanup
      run: |
        # 清理优化版本
        rm -f server/server_optimized client/client_optimized config_perf.sh
        ./build.sh clean
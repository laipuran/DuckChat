# DuckChat 系统架构

## 项目概述

DuckChat 是一个基于 C/S 架构的命令行即时通讯应用，支持用户注册登录、多聊天室管理、实时消息收发和消息撤回功能。

## 核心组件

### 服务器端
负责所有后台逻辑和数据存储，主要功能包括：
- 用户注册、登录认证
- 消息路由和转发
- 聊天室管理
- 聊天记录持久化存储

### 客户端
负责用户交互和通信，主要功能包括：
- 用户界面显示（基于 ncurses）
- 消息发送和接收
- 消息加解密处理
- 本地聊天记录管理

## 技术栈

### 服务器端技术
- **网络通信**: Socket 编程
- **数据存储**: SQLite 数据库
- **并发处理**: 多线程管理
- **数据序列化**: JSON 格式

### 客户端技术
- **用户界面**: ncurses 库
- **消息加密**: AES 加密算法
- **网络通信**: Socket 编程
- **多线程处理**: 消息队列和界面更新

## 系统架构图

```
┌─────────────────┐    Socket通信     ┌─────────────────┐
│                 │ ←────────────→    │                 │
│   DuckChat      │                   │   DuckChat      │
│   客户端        │                   │   服务器        │
│                 │                   │                 │
├─────────────────┤                   ├─────────────────┤
│ • 用户界面      │                   │ • 连接管理      │
│ • 消息处理      │                   │ • 协议解析      │
│ • 加解密        │                   │ • 数据库操作    │
│ • 本地存储      │                   │ • 消息路由      │
└─────────────────┘                   └─────────────────┘
                                               │
                                               ▼
                                    ┌─────────────────┐
                                    │                 │
                                    │   SQLite        │
                                    │   数据库        │
                                    │                 │
                                    ├─────────────────┤
                                    │ • users         │
                                    │ • chats         │
                                    │ • chat_members  │
                                    │ • messages      │
                                    └─────────────────┘
```

## 数据流程

### 用户注册流程
1. 客户端发送 REGISTER 请求
2. 服务器验证用户名唯一性
3. 服务器存储用户信息到数据库
4. 服务器返回注册结果

### 消息发送流程
1. 客户端构造 MESSAGE 协议
2. 客户端加密消息内容
3. 服务器接收并验证消息
4. 服务器存储消息到数据库
5. 服务器转发消息给目标用户
6. 客户端接收并解密消息

### 消息撤回流程
1. 客户端发送 RECALL 请求
2. 服务器验证撤回权限
3. 服务器更新数据库状态
4. 服务器通知其他用户消息已撤回

## 关键设计决策

### 1. 协议设计
- 使用 JSON 格式进行数据序列化
- 统一的请求/响应协议格式
- 支持异步消息推送

### 2. 数据库设计
- 规范化表结构设计
- 合理的索引优化
- 支持消息撤回的状态管理

### 3. 安全设计
- 客户端消息加密传输
- 服务器端密码哈希存储
- 防止 SQL 注入攻击

### 4. 并发设计
- 服务器端多线程处理客户端连接
- 客户端分离 UI 线程和网络线程
- 使用消息队列进行线程间通信

## 开发阶段规划

1. **设计阶段**: ✅ 已完成 - 通信协议和数据库结构已确定
2. **实现阶段**: ✅ 已完成 - 服务器端和客户端核心功能已实现
3. **集成阶段**: ✅ 已完成 - 端到端测试和调试已完成
4. **优化阶段**: ⏳ 进行中 - UI优化和用户体验提升

## 当前实现状态

### 服务器端 (85% 完成)
- ✅ 用户注册、登录认证
- ✅ 消息路由和转发
- ✅ 聊天室管理（创建、加入、离开）
- ✅ 聊天记录持久化存储
- ✅ 消息撤回功能
- ✅ 会话管理和错误处理

### 客户端 (75% 完成)
- ✅ 用户界面基础框架（基于 ncurses）
- ✅ 消息发送和接收
- ✅ 聊天室管理
- ✅ 本地聊天记录管理
- ⏳ 消息加解密处理
- ⏳ 完整的UI渲染和交互

### 数据库 (100% 完成)
- ✅ 完整的表结构设计
- ✅ 所有CRUD操作实现
- ✅ 数据一致性和完整性保证

### 协议 (100% 完成)
- ✅ 统一的请求/响应协议格式
- ✅ 支持异步消息推送
- ✅ JSON格式数据序列化

## 剩余工作重点

1. **UI渲染优化**: 完善ncurses窗口渲染，实现正确的消息显示和滚动
2. **用户体验提升**: 添加快捷键、状态提示、错误信息显示
3. **功能扩展**: 消息加密、文件传输、表情支持
4. **性能优化**: 大量消息时的渲染性能优化
5. **测试完善**: 端到端功能测试和压力测试
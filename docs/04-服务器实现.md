# DuckChat æœåŠ¡å™¨å®ç°

æœ¬æ–‡æ¡£æè¿°äº† DuckChat æœåŠ¡å™¨çš„å…·ä½“å®ç°é€»è¾‘å’Œä»£ç ç»“æ„ï¼ŒåŸºäºå®é™…çš„ä»£ç å®ç°ã€‚

## æ ¸å¿ƒæ¶æ„

### ä¸»è¦ç»„ä»¶
- **ä¸»æœåŠ¡å™¨** ([`server.cpp`](../server/server.cpp)): ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆ›å»ºä¼šè¯
- **ä¼šè¯ç®¡ç†å™¨** ([`session_manager.hpp`](../server/session_manager.hpp)): ç®¡ç†æ‰€æœ‰å®¢æˆ·ç«¯ä¼šè¯
- **ä¼šè¯ç±»** ([`session.hpp`](../server/session.hpp)): å¤„ç†å•ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚
- **æ•°æ®åº“ç®¡ç†å™¨** ([`database.hpp`](../server/database.hpp)): å¤„ç†æ‰€æœ‰æ•°æ®åº“æ“ä½œ
- **é€šä¿¡åè®®** ([`common/protocal.hpp`](../common/protocal.hpp)): å®šä¹‰æ•°æ®åŒ…æ ¼å¼
- **ç½‘ç»œé€šä¿¡** ([`common/network.hpp`](../common/network.hpp)): å¤„ç†ç½‘ç»œä¼ è¾“

### çº¿ç¨‹æ¨¡å‹
```
ä¸»çº¿ç¨‹ (ç›‘å¬è¿æ¥)
â”œâ”€â”€ ä¼šè¯çº¿ç¨‹1 (å¤„ç†å®¢æˆ·ç«¯1)
â”œâ”€â”€ ä¼šè¯çº¿ç¨‹2 (å¤„ç†å®¢æˆ·ç«¯2)
â”œâ”€â”€ ä¼šè¯çº¿ç¨‹3 (å¤„ç†å®¢æˆ·ç«¯3)
â””â”€â”€ ...
```

æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ¥å¤„ç†è¯¥å®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚ã€‚

## æ ¸å¿ƒç±»è®¾è®¡

### ä¸»æœåŠ¡å™¨ (server.cpp)

æœåŠ¡å™¨é‡‡ç”¨ç®€å•çš„å¾ªç¯ç›‘å¬æ¨¡å¼ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ›å»ºç‹¬ç«‹çš„å¤„ç†çº¿ç¨‹ï¼š

```cpp
// æ ¸å¿ƒå¯åŠ¨é€»è¾‘ - å®Œæ•´å®ç°è§: server/server.cpp:21-46
signal(SIGPIPE, SIG_IGN);
int server_fd = socket(AF_INET, SOCK_STREAM, 0);

sockaddr_in address;
address.sin_family = AF_INET;
address.sin_addr.s_addr = INADDR_ANY;
address.sin_port = htons(5001);  // ç›‘å¬5001ç«¯å£

bind(server_fd, (sockaddr *)&address, sizeof(address));
listen(server_fd, 10);

while (true) {
    int client_sock = accept(server_fd, (sockaddr *)&address, (socklen_t *)&addrlen);
    session_manager.create_and_start_session(client_sock);
}
```

> ğŸ’¡ **è®¾è®¡å†³ç­–**: é‡‡ç”¨"ä¸€è¿æ¥ä¸€çº¿ç¨‹"æ¨¡å‹ï¼Œç®€åŒ–å¹¶å‘å¤„ç†é€»è¾‘ï¼Œé€‚åˆä¸­å°è§„æ¨¡åº”ç”¨ã€‚

### SessionManager ç±»
```cpp
class SessionManager {
private:
    Database database;                                         // æ•°æ®åº“å®ä¾‹
    std::mutex sessions_mutex;                                 // ä¼šè¯åˆ—è¡¨äº’æ–¥é”
    std::unordered_map<int, std::unique_ptr<Session>> sessions; // ä¼šè¯åˆ—è¡¨

public:
    SessionManager();
    void create_and_start_session(int socket);
    void close_session(int socket);
    Database* get_database();
    int get_socket_by_user_id(const std::string& user_id);
};
```

**å…³é”®æ–¹æ³•å®ç°:**

| æ–¹æ³• | åŠŸèƒ½ | å®ç°ä½ç½® |
|------|------|----------|
| `create_and_start_session()` | åˆ›å»ºæ–°ä¼šè¯å¹¶å¯åŠ¨å¤„ç†çº¿ç¨‹ | [`session_manager.cpp:11`](../server/session_manager.cpp:11) |
| `get_database()` | è¿”å›æ•°æ®åº“å®ä¾‹æŒ‡é’ˆ | [`session_manager.cpp:35`](../server/session_manager.cpp:35) |
| `get_socket_by_user_id()` | æ ¹æ®ç”¨æˆ·IDæŸ¥æ‰¾å¯¹åº”çš„socket | [`session_manager.cpp:40`](../server/session_manager.cpp:40) |
| `close_session()` | å…³é—­æŒ‡å®šä¼šè¯å¹¶æ¸…ç†èµ„æº | [`session_manager.cpp:22`](../server/session_manager.cpp:22) |

> ğŸ’¡ **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ `std::mutex sessions_mutex` ä¿æŠ¤ä¼šè¯åˆ—è¡¨çš„å¹¶å‘è®¿é—®ã€‚

### Session ç±»
```cpp
class Session {
private:
    int socket;                    // å®¢æˆ·ç«¯socket
    SessionManager* session_manager; // ä¼šè¯ç®¡ç†å™¨æŒ‡é’ˆ

public:
    std::string username;          // ç”¨æˆ·å
    std::string user_id;           // ç”¨æˆ·ID
    
    Session(int socket, SessionManager* session_manager);
    void handle_session();
    ServerStatus handle_login(const ClientPacket& packet);
    ServerStatus handle_register(const ClientPacket& packet);
    void handle_message(const ClientPacket& packet);
    ServerStatus handle_new_chat(const ClientPacket& packet, const string& uuid);
    ServerStatus handle_join_chat(const ClientPacket& packet);
    ServerStatus handle_recall_message(const ClientPacket& packet);
    ServerStatus handle_leave_chat(const ClientPacket& packet);
};
```

**æ ¸å¿ƒå¤„ç†é€»è¾‘:**

| æ–¹æ³• | åŠŸèƒ½ | å®ç°ä½ç½® |
|------|------|----------|
| `handle_session()` | ä¸»ä¼šè¯å¤„ç†å¾ªç¯ | [`session.cpp:9`](../server/session.cpp:9) |
| `handle_login()` | å¤„ç†ç”¨æˆ·ç™»å½• | [`session.cpp:144`](../server/session.cpp:144) |
| `handle_register()` | å¤„ç†ç”¨æˆ·æ³¨å†Œ | [`session.cpp:161`](../server/session.cpp:161) |
| `handle_message()` | å¤„ç†æ¶ˆæ¯å‘é€å’Œå¹¿æ’­ | [`session.cpp:176`](../server/session.cpp:176) |
| `handle_new_chat()` | å¤„ç†åˆ›å»ºèŠå¤©å®¤ | [`session.cpp:211`](../server/session.cpp:211) |
| `handle_join_chat()` | å¤„ç†åŠ å…¥èŠå¤©å®¤ | [`session.cpp:222`](../server/session.cpp:222) |
| `handle_recall_message()` | å¤„ç†æ¶ˆæ¯æ’¤å› | [`session.cpp:232`](../server/session.cpp:232) |
| `handle_leave_chat()` | å¤„ç†ç¦»å¼€èŠå¤©å®¤ | [`session.cpp:247`](../server/session.cpp:247) |

## åè®®å¤„ç†é€»è¾‘

### å®¢æˆ·ç«¯åè®®å®šä¹‰ ([`common/protocal.hpp`](../common/protocal.hpp))

#### ClientMessage æšä¸¾
```cpp
enum class ClientMessage {
    REGISTER,        // ç”¨æˆ·æ³¨å†Œ
    LOGIN,           // ç”¨æˆ·ç™»å½•
    MESSAGE,         // å‘é€æ¶ˆæ¯
    RECALL,          // æ’¤å›æ¶ˆæ¯
    LIST_CHATS,      // è·å–èŠå¤©åˆ—è¡¨
    FETCH_MESSAGES,  // è·å–å†å²æ¶ˆæ¯
    CREATE_CHAT,     // åˆ›å»ºèŠå¤©å®¤
    JOIN_CHAT,       // åŠ å…¥èŠå¤©å®¤
    LEAVE_CHAT,      // ç¦»å¼€èŠå¤©å®¤
    LOGOUT,          // ç”¨æˆ·ç™»å‡º
};
```

#### ClientPacket ç»“æ„
```cpp
struct ClientPacket {
    ClientMessage request;
    std::string username;        // ç”¨æˆ·åï¼ˆæ³¨å†Œæ—¶ä½¿ç”¨ï¼‰
    std::string password_hash;   // å¯†ç å“ˆå¸Œï¼ˆç™»å½•æ—¶ä½¿ç”¨ï¼‰
    std::string user_id;          // ç”¨æˆ·ID
    std::string chat_id;          // èŠå¤©å®¤ID
    std::string chatname;         // èŠå¤©å®¤åç§°
    std::string message_id;       // æ¶ˆæ¯ID
    std::string message;          // æ¶ˆæ¯å†…å®¹
};
```

### æœåŠ¡å™¨åè®®å®šä¹‰

#### ServerMessage æšä¸¾
```cpp
enum class ServerMessage {
    REGISTER_RESPONSE,   // æ³¨å†Œå“åº”
    LOGIN_RESPONSE,      // ç™»å½•å“åº”
    CREATE_CHAT_RESPONSE,// åˆ›å»ºèŠå¤©å®¤å“åº”
    JOIN_CHAT_RESPONSE,  // åŠ å…¥èŠå¤©å®¤å“åº”
    RETURN_CHATS,        // è¿”å›èŠå¤©åˆ—è¡¨
    RETURN_MESSAGES      // è¿”å›æ¶ˆæ¯åˆ—è¡¨
};
```

#### ServerStatus æšä¸¾
```cpp
enum class ServerStatus {
    SUCCESS,           // æ“ä½œæˆåŠŸ
    USER_NOT_FOUND,    // ç”¨æˆ·ä¸å­˜åœ¨
    INVALID_PASSWORD,  // å¯†ç é”™è¯¯
    USER_EXISTS,       // ç”¨æˆ·å·²å­˜åœ¨
    CHAT_NOT_FOUND,    // èŠå¤©å®¤ä¸å­˜åœ¨
    CHAT_EXISTS,       // èŠå¤©å®¤å·²å­˜åœ¨
};
```

### ä¼šè¯å¤„ç†æµç¨‹

#### ä¸»å¤„ç†å¾ªç¯æ¶æ„

æœåŠ¡å™¨çš„ä¼šè¯å¤„ç†é‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨ [`session.cpp:9-142`](../server/session.cpp:9)ï¼š

```mermaid
graph TD
    A[å¼€å§‹ä¼šè¯å¾ªç¯] --> B{æ£€æŸ¥è¿æ¥çŠ¶æ€}
    B -->|è¿æ¥æ–­å¼€| C[å…³é—­ä¼šè¯]
    B -->|è¿æ¥æ­£å¸¸| D[æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚]
    D --> E{è¯·æ±‚ç±»å‹åˆ¤æ–­}
    
    E -->|LOGIN| F[å¤„ç†ç™»å½•]
    E -->|REGISTER| G[å¤„ç†æ³¨å†Œ]
    E -->|MESSAGE| H[å¤„ç†æ¶ˆæ¯]
    E -->|RECALL| I[å¤„ç†æ’¤å›]
    E -->|CREATE_CHAT| J[åˆ›å»ºèŠå¤©å®¤]
    E -->|JOIN_CHAT| K[åŠ å…¥èŠå¤©å®¤]
    E -->|LIST_CHATS| L[è·å–èŠå¤©åˆ—è¡¨]
    E -->|FETCH_MESSAGES| M[è·å–æ¶ˆæ¯å†å²]
    E -->|LEAVE_CHAT| N[ç¦»å¼€èŠå¤©å®¤]
    
    F --> O[å‘é€å“åº”]
    G --> O
    H --> P[å¹¿æ’­æ¶ˆæ¯]
    I --> O
    J --> O
    K --> O
    L --> O
    M --> O
    N --> O
    
    O --> B
    P --> B
    C --> Q[ç»“æŸå¾ªç¯]
```

#### æ ¸å¿ƒå¤„ç†é€»è¾‘ç®€åŒ–ç¤ºä¾‹

```cpp
// å®Œæ•´å®ç°è§: session.cpp:9-142
void Session::handle_session() {
    while (true) {
        if (!check_online(socket)) {
            session_manager->close_session(socket);
            break;
        }
        ClientPacket packet = recv_client_packet(socket);
        
        // æ ¹æ®è¯·æ±‚ç±»å‹åˆ†å‘å¤„ç† - è¯¦ç»†å®ç°åœ¨å„handle_*æ–¹æ³•ä¸­
        switch (packet.request) {
            case ClientMessage::LOGIN: /* å¤„ç†ç™»å½• */ break;
            case ClientMessage::MESSAGE: /* å¤„ç†æ¶ˆæ¯å¹¿æ’­ */ break;
            // ... å…¶ä»–è¯·æ±‚ç±»å‹
        }
    }
}
```

#### å…³é”®ä¸šåŠ¡é€»è¾‘

**ç”¨æˆ·è®¤è¯æµç¨‹:**

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant S as æœåŠ¡å™¨ä¼šè¯
    participant DB as æ•°æ®åº“
    
    C->>S: LOGINè¯·æ±‚(user_id, password_hash)
    S->>DB: exist_user(user_id)
    DB-->>S: ç”¨æˆ·å­˜åœ¨çŠ¶æ€
    alt ç”¨æˆ·ä¸å­˜åœ¨
        S-->>C: USER_NOT_FOUND
    else ç”¨æˆ·å­˜åœ¨
        S->>DB: get_password_hash(user_id)
        DB-->>S: å­˜å‚¨çš„å¯†ç å“ˆå¸Œ
        alt å¯†ç åŒ¹é…
            S->>S: è®¾ç½®ä¼šè¯ç”¨æˆ·ä¿¡æ¯
            S-->>C: SUCCESS + ç”¨æˆ·ä¿¡æ¯
        else å¯†ç ä¸åŒ¹é…
            S-->>C: INVALID_PASSWORD
        end
    end
```

**ç™»å½•å¤„ç†** - [`session.cpp:144-159`](../server/session.cpp:144):
```cpp
Database* db = session_manager->get_database();
if (!db->exist_user(packet.user_id))
    return ServerStatus::USER_NOT_FOUND;

if (packet.password_hash == db->get_password_hash(packet.user_id)) {
    user_id = packet.user_id;
    username = db->get_username(packet.user_id);
    return ServerStatus::SUCCESS;
}
return ServerStatus::INVALID_PASSWORD;
```

**æ³¨å†Œå¤„ç†** - [`session.cpp:161-174`](../server/session.cpp:161):
```cpp
Database* db = session_manager->get_database();
if (db->exist_user(packet.user_id))
    return ServerStatus::USER_EXISTS;

db->add_user(packet.user_id, packet.username, packet.password_hash);
user_id = packet.user_id;
username = packet.username;
return ServerStatus::SUCCESS;
```

> âš ï¸ **å®‰å…¨æ³¨æ„**: å½“å‰å®ç°ä½¿ç”¨SHA256å“ˆå¸Œï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ·»åŠ ç›å€¼(salt)å¢å¼ºå®‰å…¨æ€§ã€‚

## æ•°æ®åº“å®ç°

### Database ç±»ç»“æ„ ([`database.hpp`](../server/database.hpp))

#### æ•°æ®ç»“æ„å®šä¹‰
```cpp
struct ChatInfo {
    std::string chat_id;
    std::string chatname;
    std::string creator_user_id;
    std::vector<std::string> members; 
};

struct Message {
    std::string message_id;
    std::string user_id;
    std::string content;
    std::string timestamp;
};
```

#### æ ¸å¿ƒæ•°æ®åº“æ“ä½œ

| åˆ†ç±» | æ–¹æ³• | åŠŸèƒ½ | å®ç°ä½ç½® |
|------|------|------|----------|
| **ç”¨æˆ·ç®¡ç†** | `exist_user()` | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ | [`database.cpp:62`](../server/database.cpp:62) |
| | `add_user()` | æ·»åŠ æ–°ç”¨æˆ· | [`database.cpp:80`](../server/database.cpp:80) |
| | `get_username()` | è·å–ç”¨æˆ·å | [`database.cpp:99`](../server/database.cpp:99) |
| | `get_password_hash()` | è·å–å¯†ç å“ˆå¸Œ | [`database.cpp:119`](../server/database.cpp:119) |
| **æ¶ˆæ¯ç®¡ç†** | `add_message()` | æ·»åŠ æ¶ˆæ¯åˆ°æ•°æ®åº“ | [`database.cpp:139`](../server/database.cpp:139) |
| | `delete_message()` | åˆ é™¤æ¶ˆæ¯ï¼ˆæ’¤å›åŠŸèƒ½ï¼‰ | [`database.cpp:160`](../server/database.cpp:160) |
| | `fetch_chat_messages()` | è·å–èŠå¤©å®¤æ¶ˆæ¯å†å² | [`database.cpp:236`](../server/database.cpp:236) |
| **èŠå¤©å®¤ç®¡ç†** | `chat_exist()` | æ£€æŸ¥èŠå¤©å®¤æ˜¯å¦å­˜åœ¨ | [`database.cpp:174`](../server/database.cpp:174) |
| | `get_chatname()` | è·å–èŠå¤©å®¤åç§° | [`database.cpp:192`](../server/database.cpp:192) |
| | `add_chat()` | åˆ›å»ºæ–°èŠå¤©å®¤ | [`database.cpp:265`](../server/database.cpp:265) |
| **æˆå‘˜ç®¡ç†** | `list_user_chats()` | è·å–ç”¨æˆ·å‚ä¸çš„èŠå¤©åˆ—è¡¨ | [`database.cpp:212`](../server/database.cpp:212) |
| | `get_chat_members()` | è·å–èŠå¤©å®¤æˆå‘˜åˆ—è¡¨ | [`database.cpp:284`](../server/database.cpp:284) |
| | `add_chat_member()` | æ·»åŠ èŠå¤©å®¤æˆå‘˜ | [`database.cpp:304`](../server/database.cpp:304) |
| | `leave_chat()` | ç”¨æˆ·ç¦»å¼€èŠå¤©å®¤ | [`database.cpp:323`](../server/database.cpp:323) |

### æ•°æ®åº“åˆå§‹åŒ– ([`database.cpp:19-53`](../server/database.cpp:19))

#### è¡¨ç»“æ„
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS users (
    user_id TEXT PRIMARY KEY,
    username TEXT NOT NULL,
    password_hash TEXT NOT NULL
);

-- èŠå¤©å®¤è¡¨
CREATE TABLE IF NOT EXISTS chats (
    chat_id TEXT PRIMARY KEY,
    chatname TEXT NOT NULL,
    creator_id TEXT NOT NULL,
    FOREIGN KEY (creator_id) REFERENCES users(user_id)
);

-- èŠå¤©å®¤æˆå‘˜è¡¨
CREATE TABLE IF NOT EXISTS chat_members (
    chat_id TEXT,
    user_id TEXT NOT NULL,
    role TEXT DEFAULT 'member',
    FOREIGN KEY (chat_id) REFERENCES chats(chat_id),
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    UNIQUE(chat_id, user_id)
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE IF NOT EXISTS messages (
    message_id TEXT PRIMARY KEY,
    chat_id TEXT NOT NULL,
    sender_id TEXT NOT NULL,
    content TEXT NOT NULL,
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (chat_id) REFERENCES chats(chat_id),
    FOREIGN KEY (sender_id) REFERENCES users(user_id)
);
```

## ç½‘ç»œé€šä¿¡

### ç½‘ç»œé€šä¿¡å®ç°

#### æ•°æ®åŒ…ä¼ è¾“æœºåˆ¶

ç½‘ç»œå±‚é‡‡ç”¨é•¿åº¦å‰ç¼€çš„JSONåè®®ï¼Œç¡®ä¿æ¶ˆæ¯å®Œæ•´æ€§ï¼š

```cpp
// æ ¸å¿ƒç½‘ç»œå‡½æ•° - å®Œæ•´å®ç°è§: common/network.cpp
void send_packet(int socket, const ClientPacket& packet);     // å‘é€å®¢æˆ·ç«¯åŒ…
void send_packet(int socket, const ServerPacket& packet);     // å‘é€æœåŠ¡å™¨åŒ…
ClientPacket recv_client_packet(int socket);                   // æ¥æ”¶å®¢æˆ·ç«¯åŒ…
ServerPacket recv_server_packet(int socket);                   // æ¥æ”¶æœåŠ¡å™¨åŒ…
bool check_online(int socket);                                 // æ£€æŸ¥è¿æ¥çŠ¶æ€
```

#### åè®®ä¼ è¾“æ ¼å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   4å­—èŠ‚é•¿åº¦   â”‚    JSONæ•°æ®åŒ…        â”‚
â”‚  (ç½‘ç»œå­—èŠ‚åº)  â”‚   (UTF-8ç¼–ç )       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‘é€æµç¨‹** - [`network.cpp:14-50`](../common/network.cpp:14):
```cpp
// 1. JSONåºåˆ—åŒ–
json serialized = packet;
string json_string = serialized.dump();

// 2. å‘é€é•¿åº¦å‰ç¼€
uint32_t length = htonl(json_string.length());
send(socket, &length, sizeof(length), 0);

// 3. å‘é€JSONæ•°æ®
send(socket, json_string.c_str(), json_string.length(), 0);
```

**æ¥æ”¶æµç¨‹** - [`network.cpp:52-96`](../common/network.cpp:52):
```cpp
// 1. æ¥æ”¶é•¿åº¦å‰ç¼€
uint32_t net_length;
recv(socket, &net_length, sizeof(uint32_t), 0);
uint32_t host_length = ntohl(net_length);

// 2. å®‰å…¨æ£€æŸ¥
if (host_length > MAX_PACKET_SIZE) return Packet();

// 3. æ¥æ”¶JSONæ•°æ®å¹¶ååºåˆ—åŒ–
string json_string;
json_string.resize(host_length);
recv(socket, &json_string[0], host_length, 0);
return json::parse(json_string).get<Packet>();
```

> ğŸ’¡ **å®‰å…¨ç‰¹æ€§**: å®ç°äº†æœ€å¤§åŒ…å¤§å°é™åˆ¶(1MB)é˜²æ­¢å†…å­˜æ”»å‡»ï¼Œä½¿ç”¨SIGPIPEå¤„ç†é˜²æ­¢è¿›ç¨‹å´©æºƒã€‚

## æ—¥å¿—ç³»ç»Ÿ

### æ—¥å¿—çº§åˆ«å’Œæ ¼å¼

ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ¥å£ [`common/log_helper.hpp`](../common/log_helper.hpp)ï¼š

```cpp
enum class LogLevel {
    DEBUG,    // è°ƒè¯•ä¿¡æ¯
    INFO,     // ä¸€èˆ¬ä¿¡æ¯
    WARNING,  // è­¦å‘Šä¿¡æ¯
    ERROR     // é”™è¯¯ä¿¡æ¯
};

// ä½¿ç”¨ç¤ºä¾‹
log(LogLevel::INFO, "Client connected: " + client_ip);
log(LogLevel::ERROR, "Database operation failed");
```

### å…³é”®æ—¥å¿—è®°å½•ç‚¹

| ä½ç½® | äº‹ä»¶ | æ—¥å¿—çº§åˆ« |
|------|------|----------|
| [`server.cpp:43`](../server/server.cpp:43) | å®¢æˆ·ç«¯è¿æ¥ | INFO |
| [`session.cpp:34`](../server/session.cpp:34) | ç™»å½•å¤±è´¥ | ERROR |
| [`session.cpp:40`](../server/session.cpp:40) | ç™»å½•æˆåŠŸ | INFO |
| [`session.cpp:61`](../server/session.cpp:61) | æ¶ˆæ¯å‘é€ | INFO |
| [`session_manager.cpp:29`](../server/session_manager.cpp:29) | ä¼šè¯å…³é—­ | INFO |

> ğŸ’¡ **è°ƒè¯•æŠ€å·§**: åœ¨å¼€å‘é˜¶æ®µå¯å°†æ—¥å¿—çº§åˆ«è®¾ä¸ºDEBUGï¼Œç”Ÿäº§ç¯å¢ƒè®¾ä¸ºINFOä»¥å‡å°‘æ—¥å¿—é‡ã€‚

## å½“å‰å®ç°çŠ¶æ€

### âœ… å·²å®ç°åŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | å®ç°çŠ¶æ€ | å…³é”®æ–‡ä»¶ |
|----------|----------|----------|
| **æœåŠ¡å™¨å¯åŠ¨** | âœ… å®Œæˆ | [`server.cpp:21-49`](../server/server.cpp:21) |
| **ä¼šè¯ç®¡ç†** | âœ… å®Œæˆ | [`session_manager.cpp`](../server/session_manager.cpp) |
| **ç”¨æˆ·è®¤è¯** | âœ… å®Œæˆ | [`session.cpp:144-174`](../server/session.cpp:144) |
| **æ¶ˆæ¯ç³»ç»Ÿ** | âœ… å®Œæˆ | [`session.cpp:176-209`](../server/session.cpp:176) |
| **èŠå¤©å®¤ç®¡ç†** | âœ… å®Œæˆ | [`session.cpp:211-260`](../server/session.cpp:211) |
| **æ•°æ®åº“æ“ä½œ** | âœ… å®Œæˆ | [`database.cpp`](../server/database.cpp) |
| **ç½‘ç»œé€šä¿¡** | âœ… å®Œæˆ | [`network.cpp`](../common/network.cpp) |
| **æ—¥å¿—ç³»ç»Ÿ** | âœ… å®Œæˆ | [`log_helper.hpp`](../common/log_helper.hpp) |

### â³ å¾…å®ç°åŠŸèƒ½

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å®ç°å»ºè®® |
|------|--------|----------|
| **å¿ƒè·³æœºåˆ¶** | é«˜ | å®šæœŸæ£€æµ‹å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€ï¼Œè‡ªåŠ¨æ¸…ç†æ–­å¼€è¿æ¥ |
| **æ¶ˆæ¯åŠ å¯†** | ä¸­ | ä½¿ç”¨AES-256-CBCåŠ å¯†æ•æ„Ÿæ¶ˆæ¯å†…å®¹ |
| **æ–‡ä»¶ä¼ è¾“** | ä¸­ | æ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ç­‰æ–‡ä»¶ç±»å‹ä¼ è¾“ |
| **åœ¨çº¿çŠ¶æ€** | ä½ | æ˜¾ç¤ºç”¨æˆ·åœ¨çº¿/ç¦»çº¿çŠ¶æ€ |
| **ç¾¤ç»„æƒé™** | ä½ | ç®¡ç†å‘˜ã€æˆå‘˜ç­‰è§’è‰²æƒé™ç®¡ç† |

### ğŸ”§ å…³é”®è®¾è®¡å†³ç­–

| å†³ç­–ç‚¹ | é€‰æ‹©çš„æ–¹æ¡ˆ | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|--------|------------|------|----------|
| **å¹¶å‘æ¨¡å‹** | ä¸€è¿æ¥ä¸€çº¿ç¨‹ | å®ç°ç®€å•ï¼Œé€‚åˆä¸­å°è§„æ¨¡ | äº‹ä»¶é©±åŠ¨(epoll) |
| **æ•°æ®åº“** | SQLite | è½»é‡çº§ï¼Œæ— éœ€é¢å¤–éƒ¨ç½² | MySQL/PostgreSQL |
| **åè®®æ ¼å¼** | JSON + é•¿åº¦å‰ç¼€ | æ˜“äºè°ƒè¯•ï¼Œè·¨è¯­è¨€å…¼å®¹ | Protocol Buffers |
| **è®¤è¯æ–¹å¼** | SHA256å“ˆå¸Œ | å®ç°ç®€å•ï¼Œæ€§èƒ½å¥½ | bcrypt/ PBKDF2 |

### ğŸ“Š æ€§èƒ½ç‰¹å¾

| æŒ‡æ ‡ | å½“å‰è¡¨ç° | ä¼˜åŒ–å»ºè®® |
|------|----------|----------|
| **å¹¶å‘è¿æ¥** | çº¿ç¨‹æ•°é™åˆ¶ | ä½¿ç”¨è¿æ¥æ± æˆ–äº‹ä»¶é©±åŠ¨ |
| **å†…å­˜ä½¿ç”¨** | æ¯è¿æ¥çº¦1MB | ä¼˜åŒ–ä¼šè¯æ•°æ®ç»“æ„ |
| **æ¶ˆæ¯å»¶è¿Ÿ** | <10ms (å±€åŸŸç½‘) | å¼‚æ­¥I/Oä¼˜åŒ– |
| **æ•°æ®åº“æŸ¥è¯¢** | ç®€å•æŸ¥è¯¢<1ms | æ·»åŠ ç´¢å¼•ä¼˜åŒ– |

## æ€§èƒ½å’Œå®‰å…¨è€ƒè™‘

### ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

| ä¼˜åŒ–æ–¹å‘ | å½“å‰å®ç° | æ”¹è¿›å»ºè®® |
|----------|----------|----------|
| **å¹¶å‘å¤„ç†** | çº¿ç¨‹æ¨¡å‹ | è€ƒè™‘äº‹ä»¶é©±åŠ¨æ¨¡å‹(epoll)æå‡å¹¶å‘èƒ½åŠ› |
| **å†…å­˜ç®¡ç†** | åŸºç¡€RAII | å®ç°å¯¹è±¡æ± å¤ç”¨ï¼Œå‡å°‘å†…å­˜åˆ†é… |
| **æ•°æ®åº“ä¼˜åŒ–** | åŸºç¡€æŸ¥è¯¢ | æ·»åŠ ç´¢å¼•ï¼Œå®ç°æŸ¥è¯¢ç¼“å­˜ |
| **ç½‘ç»œI/O** | é˜»å¡æ¨¡å¼ | ä½¿ç”¨å¼‚æ­¥I/Oæå‡ååé‡ |

### ğŸ”’ å®‰å…¨æªæ–½

| å®‰å…¨å±‚é¢ | å½“å‰çŠ¶æ€ | æ”¹è¿›å»ºè®® |
|----------|----------|----------|
| **å¯†ç å®‰å…¨** | SHA256å“ˆå¸Œ | æ·»åŠ ç›å€¼ï¼Œè€ƒè™‘bcryptæˆ–PBKDF2 |
| **è¾“å…¥éªŒè¯** | åŸºç¡€æ£€æŸ¥ | å®Œå–„å‚æ•°éªŒè¯ï¼Œé˜²æ­¢æ³¨å…¥æ”»å‡» |
| **ä¼ è¾“å®‰å…¨** | æ˜æ–‡ä¼ è¾“ | å®ç°TLS/SSLåŠ å¯†é€šé“ |
| **è®¿é—®æ§åˆ¶** | åŸºç¡€è®¤è¯ | æ·»åŠ æƒé™ç®¡ç†å’Œè®¿é—®æ§åˆ¶ |

### ğŸ“ˆ æ‰©å±•è·¯çº¿å›¾

#### çŸ­æœŸä¼˜åŒ– (1-2ä¸ªæœˆ)
1. **å¿ƒè·³æœºåˆ¶** - è‡ªåŠ¨æ£€æµ‹æ–­å¼€è¿æ¥
2. **æ¶ˆæ¯åŠ å¯†** - ç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤éšç§
3. **æ€§èƒ½ç›‘æ§** - æ·»åŠ å…³é”®æŒ‡æ ‡ç›‘æ§

#### ä¸­æœŸæ‰©å±• (3-6ä¸ªæœˆ)
1. **é›†ç¾¤éƒ¨ç½²** - æ”¯æŒå¤šæœåŠ¡å™¨è´Ÿè½½å‡è¡¡
2. **ç¼“å­˜ç³»ç»Ÿ** - Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
3. **æ–‡ä»¶ä¼ è¾“** - æ”¯æŒå¤šåª’ä½“æ–‡ä»¶åˆ†äº«

#### é•¿æœŸè§„åˆ’ (6ä¸ªæœˆ+)
1. **å¾®æœåŠ¡æ¶æ„** - æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å¾®æœåŠ¡
2. **æ¶ˆæ¯é˜Ÿåˆ—** - ä½¿ç”¨RabbitMQ/Kafkaå¤„ç†é«˜å¹¶å‘
3. **AIé›†æˆ** - æ™ºèƒ½æ¶ˆæ¯å¤„ç†å’Œæ¨è
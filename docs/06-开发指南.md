# DuckChat 开发指南

本文档为 DuckChat 项目的开发者提供详细的开发环境搭建、编码规范和开发流程指导。

## 开发环境要求

### 系统要求
- **操作系统**: Linux (推荐 Ubuntu 20.04+)
- **编译器**: GCC 9.0+ 或 Clang 10.0+
- **构建工具**: Make 3.8+
- **版本控制**: Git 2.25+

### 依赖库
```bash
# 核心依赖
sudo apt-get update
sudo apt-get install build-essential cmake

# 网络和系统库
sudo apt-get install libssl-dev zlib1g-dev

# ncurses 库 (客户端UI)
sudo apt-get install libncurses5-dev libncursesw5-dev

# SQLite 数据库
sudo apt-get install sqlite3 libsqlite3-dev

# JSON 处理库 (项目已包含)
# 项目使用 third_party/json.hpp (nlohmann/json)
```

### 开发工具推荐
```bash
# 代码编辑器/IDE
# VS Code (推荐)
sudo snap install code --classic

# 调试工具
sudo apt-get install gdb valgrind

# 代码格式化工具
sudo apt-get install clang-format

# 静态分析工具
sudo apt-get install cppcheck clang-tidy
```

## 项目结构

```
DuckChat/
├── README.md                 # 项目说明
├── Makefile                  # 构建配置
├── build.sh                  # 构建脚本
├── config.sh                 # 配置脚本
├── .gitignore               # Git忽略文件
├── docs/                    # 项目文档
│   ├── README.md
│   ├── 01-系统架构.md
│   ├── 02-通信协议.md
│   ├── 03-数据库设计.md
│   ├── 04-服务器实现.md
│   ├── 05-客户端实现.md
│   ├── 06-开发指南.md
│   └── 07-部署说明.md
├── client/                  # 客户端代码
│   ├── client.cpp
│   ├── chat_manager.cpp
│   ├── chat_manager.hpp
│   ├── window_manager.cpp
│   └── window_manager.hpp
├── server/                  # 服务器代码
│   ├── server.cpp
│   ├── database.cpp
│   ├── database.hpp
│   ├── session.cpp
│   ├── session.hpp
│   ├── session_manager.cpp
│   └── session_manager.hpp
├── common/                  # 公共代码
│   ├── log_helper.hpp
│   ├── network.cpp
│   ├── network.hpp
│   └── protocal.hpp
└── third_party/             # 第三方库
    └── json.hpp
```

## 构建和运行

### 快速构建
```bash
# 使用构建脚本
chmod +x build.sh
./build.sh

# 或使用 Make
make all
```

### 手动构建
```bash
# 创建构建目录
mkdir -p build

# 编译服务器
g++ -std=c++17 -O2 -Wall -Wextra \
    server/server.cpp \
    server/database.cpp \
    server/session.cpp \
    server/session_manager.cpp \
    common/network.cpp \
    -lsqlite3 \
    -o build/duckchat-server

# 编译客户端
g++ -std=c++17 -O2 -Wall -Wextra \
    client/client.cpp \
    client/chat_manager.cpp \
    client/window_manager.cpp \
    common/network.cpp \
    -lncurses -lsqlite3 \
    -o build/duckchat-client
```

### 运行项目
```bash
# 启动服务器
./build/duckchat-server

# 启动客户端 (新终端)
./build/duckchat-client
```

## 编码规范

### C++ 代码风格

#### 命名约定
```cpp
// 类名: PascalCase
class ChatManager {
};

// 函数名: snake_case
void handle_client_request();
bool connect_to_server();

// 变量名: snake_case
int client_socket;
std::string user_name;

// 常量: UPPER_SNAKE_CASE
const int MAX_CONNECTIONS = 100;
const std::string DEFAULT_PORT = "5001";

// 成员变量: snake_case (private加前缀_)
class Session {
private:
    int socket_;
    std::string user_id_;
    
public:
    int get_socket() const { return socket_; }
};
```

#### 文件组织
```cpp
// header guard
#pragma once

// 系统头文件
#include <iostream>
#include <string>
#include <vector>

// 第三方库头文件
#include "../third_party/json.hpp"

// 项目头文件
#include "common/network.hpp"
#include "server/database.hpp"

// 类定义
class MyClass {
    // 公共接口
public:
    MyClass();
    ~MyClass();
    
    // 公共方法
    void public_method();
    
    // 保护成员
protected:
    int protected_member_;
    
    // 私有成员
private:
    std::string private_member_;
    void private_helper();
};
```

#### 代码格式化
```bash
# 使用 clang-format 格式化代码
clang-format --style=file -i *.cpp *.hpp

# .clang-format 配置文件示例
BasedOnStyle: Google
IndentWidth: 4
ColumnLimit: 100
AllowShortFunctionsOnASingleLine: Empty
AllowShortIfStatementsOnASingleLine: false
AllowShortLoopsOnASingleLine: false
```

### 注释规范

#### 文件头注释
```cpp
/**
 * @file chat_manager.hpp
 * @brief 聊天管理器类的定义
 * @author DuckChat Team
 * @date 2024-01-01
 * 
 * 该文件定义了ChatManager类，负责管理客户端的聊天逻辑，
 * 包括消息发送、接收、加密解密等功能。
 */
```

#### 类注释
```cpp
/**
 * @class ChatManager
 * @brief 聊天管理器，处理客户端的聊天逻辑
 * 
 * ChatManager类负责：
 * - 与服务器建立连接
 * - 处理用户注册和登录
 * - 管理聊天室和消息
 * - 处理消息的加密和解密
 */
class ChatManager {
    // ...
};
```

#### 函数注释
```cpp
/**
 * @brief 发送消息到指定聊天室
 * 
 * @param chat_id 聊天室ID
 * @param message 消息内容
 * @return bool 发送成功返回true，失败返回false
 * 
 * @note 该函数会自动对消息进行AES加密
 * @warning 确保已连接到服务器且已加入聊天室
 */
bool send_message(const std::string& chat_id, const std::string& message);
```

## 开发流程

### Git 工作流

#### 分支策略
```bash
# 主分支
main          # 稳定版本
develop       # 开发分支

# 功能分支
feature/server-message-routing
feature/client-ui-improvement
feature/encryption

# 修复分支
bugfix/login-validation-error
bugfix/memory-leak

# 发布分支
release/v1.0.0
```

#### 提交规范
```bash
# 提交格式
<type>(<scope>): <subject>

<body>

<footer>

# 示例
feat(server): 添加消息路由功能

- 实现消息转发逻辑
- 添加聊天室成员管理
- 优化数据库查询性能

Closes #123
```

#### 提交类型
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建工具或辅助工具的变动

### 开发步骤

#### 1. 创建功能分支
```bash
git checkout develop
git pull origin develop
git checkout -b feature/new-feature
```

#### 2. 开发和测试
```bash
# 编写代码
# 运行测试
make test

# 代码格式化
make format

# 静态分析
make lint
```

#### 3. 提交代码
```bash
git add .
git commit -m "feat: 添加新功能"
git push origin feature/new-feature
```

#### 4. 创建Pull Request
- 在GitHub/GitLab上创建PR
- 填写详细的PR描述
- 等待代码审查
- 根据反馈修改代码

#### 5. 合并代码
```bash
# 审查通过后合并到develop
git checkout develop
git merge feature/new-feature
git push origin develop
```

## 测试指南

### 单元测试
```cpp
// test/test_database.cpp
#include <gtest/gtest.h>
#include "../server/database.hpp"

class DatabaseTest : public ::testing::Test {
protected:
    void SetUp() override {
        db = std::make_unique<Database>(":memory:");
    }
    
    void TearDown() override {
        db.reset();
    }
    
    std::unique_ptr<Database> db;
};

TEST_F(DatabaseTest, AddUser) {
    EXPECT_TRUE(db->add_user("user1", "username1", "hash1"));
    EXPECT_TRUE(db->exist_user("user1"));
    EXPECT_FALSE(db->exist_user("user2"));
}

TEST_F(DatabaseTest, DuplicateUser) {
    EXPECT_TRUE(db->add_user("user1", "username1", "hash1"));
    EXPECT_FALSE(db->add_user("user1", "username2", "hash2"));
}
```

### 集成测试
```cpp
// test/test_integration.cpp
#include <gtest/gtest.h>
#include "../server/server.hpp"
#include "../client/client.hpp"

TEST(IntegrationTest, ClientServerCommunication) {
    // 启动测试服务器
    Server server(5002);
    std::thread server_thread([&server]() {
        server.start();
    });
    
    // 连接客户端
    Client client;
    EXPECT_TRUE(client.connect("localhost", 5002));
    
    // 测试注册和登录
    EXPECT_TRUE(client.register_user("test", "testuser", "password"));
    EXPECT_TRUE(client.login_user("test", "password"));
    
    // 清理
    client.disconnect();
    server.stop();
    server_thread.join();
}
```

### 性能测试
```bash
# 使用基准测试框架
git clone https://github.com/google/benchmark.git

# 编译和运行基准测试
g++ -std=c++17 -O2 -lbenchmark -lpthread benchmark_test.cpp -o benchmark_test
./benchmark_test
```

## 调试技巧

### GDB 调试
```bash
# 编译调试版本
g++ -g -O0 -Wall -Wextra source.cpp -o debug_program

# 启动GDB
gdb ./debug_program

# 常用GDB命令
(gdb) break main                    # 设置断点
(gdb) run                           # 运行程序
(gdb) next                          # 单步执行
(gdb) print variable               # 打印变量值
(gdb) backtrace                     # 查看调用栈
(gdb) continue                      # 继续执行
```

### 内存检查
```bash
# 使用Valgrind检查内存泄漏
valgrind --leak-check=full --show-leak-kinds=all ./program

# 使用AddressSanitizer
g++ -fsanitize=address -g source.cpp -o program
./program
```

### 日志调试
```cpp
#include "../common/log_helper.hpp"

void debug_function() {
    log(LogLevel::DEBUG, "进入函数 debug_function");
    
    // 业务逻辑
    int result = calculate_something();
    log(LogLevel::INFO, "计算结果: " + std::to_string(result));
    
    if (result < 0) {
        log(LogLevel::ERROR, "计算结果异常");
    }
    
    log(LogLevel::DEBUG, "退出函数 debug_function");
}
```

## 常见问题解决

### 编译问题

#### 找不到头文件
```bash
# 检查包含路径
g++ -I./include -I./third_party source.cpp

# 检查pkg-config
pkg-config --cflags --libs sqlite3
```

#### 链接错误
```bash
# 检查库文件
g++ source.cpp -lsqlite3 -lncurses -lssl -lcrypto

# 检查库路径
g++ -L./lib source.cpp -lmylib
```

### 运行时问题

#### 段错误
```bash
# 使用GDB调试
gdb ./program
(gdb) run
(gdb) backtrace  # 查看调用栈找到问题位置
```

#### 内存泄漏
```bash
# 使用Valgrind检查
valgrind --leak-check=full ./program
```

### 网络问题

#### 连接被拒绝
```bash
# 检查端口是否被占用
netstat -tlnp | grep 5001

# 检查防火墙设置
sudo ufw status
```

## 性能优化建议

### 编译优化
```bash
# 发布版本编译选项
g++ -std=c++17 -O3 -DNDEBUG -march=native \
    -flto -ffast-math source.cpp
```

### 代码优化
```cpp
// 使用移动语义减少拷贝
std::string process_message(std::string message) {
    // 处理消息
    return processed_message;
}

// 使用引用避免拷贝
void display_messages(const std::vector<Message>& messages) {
    for (const auto& msg : messages) {
        // 显示消息
    }
}

// 预分配容器大小
std::vector<Message> messages;
messages.reserve(1000);  // 预分配空间
```

### 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_messages_chat_time ON messages(chat_id, sent_at DESC);

-- 使用事务
BEGIN TRANSACTION;
INSERT INTO messages VALUES (...);
INSERT INTO messages VALUES (...);
COMMIT;
```

## 部署准备

### 打包发布
```bash
# 创建发布目录
mkdir -p release/duckchat/{bin,config,docs}

# 复制可执行文件
cp build/duckchat-server release/duckchat/bin/
cp build/duckchat-client release/duckchat/bin/

# 复制配置文件
cp config.json release/duckchat/config/

# 复制文档
cp -r docs release/duckchat/

# 创建启动脚本
cat > release/duckchat/start-server.sh << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
./bin/duckchat-server
EOF

chmod +x release/duckchat/start-server.sh
```

### 版本管理
```bash
# 创建版本标签
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# 生成发布包
git archive --format=tar.gz --prefix=duckchat-v1.0.0/ v1.0.0 \
    > duckchat-v1.0.0.tar.gz
```

## 开发工具配置

### VS Code 配置
```json
// .vscode/settings.json
{
    "cmake.configureOnOpen": true,
    "files.associations": {
        "*.hpp": "cpp",
        "*.cpp": "cpp"
    },
    "C_Cpp.default.cppStandard": "c++17",
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
        "source.fixAll": true
    }
}
```

### Makefile 示例
```makefile
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2
INCLUDES = -I. -I./third_party
LIBS = -lsqlite3 -lncurses

SRCDIR = src
OBJDIR = obj
BINDIR = bin

SERVER_SRCS = server/server.cpp server/database.cpp server/session.cpp
CLIENT_SRCS = client/client.cpp client/chat_manager.cpp client/window_manager.cpp
COMMON_SRCS = common/network.cpp

SERVER_OBJS = $(SERVER_SRCS:%.cpp=$(OBJDIR)/%.o)
CLIENT_OBJS = $(CLIENT_SRCS:%.cpp=$(OBJDIR)/%.o)
COMMON_OBJS = $(COMMON_SRCS:%.cpp=$(OBJDIR)/%.o)

all: $(BINDIR)/duckchat-server $(BINDIR)/duckchat-client

$(BINDIR)/duckchat-server: $(SERVER_OBJS) $(COMMON_OBJS)
	@mkdir -p $(BINDIR)
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

$(BINDIR)/duckchat-client: $(CLIENT_OBJS) $(COMMON_OBJS)
	@mkdir -p $(BINDIR)
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

$(OBJDIR)/%.o: %.cpp
	@mkdir -p $(dir $@)
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

clean:
	rm -rf $(OBJDIR) $(BINDIR)

.PHONY: all clean
```

这个开发指南为 DuckChat 项目提供了完整的开发环境配置、编码规范、开发流程和调试技巧，帮助开发者快速上手并高效开发。
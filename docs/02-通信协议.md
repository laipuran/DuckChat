# DuckChat 通信协议

本文档定义了客户端与服务器之间通信的所有协议格式。所有协议使用 JSON 格式进行数据序列化。

**文档版本**: v1.0.0
**最后更新**: 2025-12-25
**维护者**: DuckChat Team

## 通用协议格式

### 请求协议格式 (ClientPacket)
```json
{
  "request": "协议类型",
  "username": "用户名",
  "password_hash": "密码哈希",
  "user_id": "用户ID",
  "chat_id": "聊天室ID",
  "chatname": "聊天室名称",
  "message_id": "消息ID",
  "message": "消息内容"
}
```

### 响应协议格式 (ServerPacket)
```json
{
  "request": "响应协议类型",
  "status": "状态码",
  "user_id": "用户ID",
  "username": "用户名",
  "chats": "聊天室列表",
  "messages": "消息列表"
}
```

## 客户端请求协议 (ClientMessage)

| 协议名称 | 说明 | 主要字段 |
|---------|------|---------|
| `REGISTER` | 用户注册 | `user_id`, `username`, `password_hash` |
| `LOGIN` | 用户登录 | `user_id`, `password_hash` |
| `MESSAGE` | 发送消息 | `user_id`, `chat_id`, `message_id`, `message`, `username` |
| `RECALL` | 撤回消息 | `user_id`, `message_id` |
| `LIST_CHATS` | 获取用户聊天列表 | `user_id` |
| `FETCH_MESSAGES` | 获取聊天历史消息 | `chat_id` |
| `CREATE_CHAT` | 创建群聊 | `user_id`, `chatname` |
| `JOIN_CHAT` | 加入群聊 | `user_id`, `chat_id` |
| `LEAVE_CHAT` | 退出群聊 | `user_id`, `chat_id` |
| `LOGOUT` | 用户登出 | `user_id` |

## 服务器响应协议 (ServerMessage)

| 协议名称 | 说明 | 主要字段 |
|---------|------|---------|
| `REGISTER_RESPONSE` | 注册响应 | `status`, `user_id`, `username` |
| `LOGIN_RESPONSE` | 登录响应 | `status`, `user_id`, `username` |
| `CREATE_CHAT_RESPONSE` | 创建群聊响应 | `status`, `user_id`, `username`, `chats` |
| `JOIN_CHAT_RESPONSE` | 加入群聊响应 | `status`, `user_id`, `username`, `chats` |
| `RETURN_CHATS` | 返回聊天列表 | `user_id`, `username`, `chats` |
| `RETURN_MESSAGES` | 返回历史消息 | `user_id`, `username`, `messages`, `chats` |
| `NEW_MESSAGE` | 新消息推送 | `status`, `messages`, `chats` |

## 服务器状态码 (ServerStatus)

| 状态码 | 说明 |
|--------|------|
| `SUCCESS` | 操作成功 |
| `USER_NOT_FOUND` | 用户不存在 |
| `INVALID_PASSWORD` | 密码错误 |
| `USER_EXISTS` | 用户已存在 |
| `CHAT_NOT_FOUND` | 聊天室不存在 |
| `CHAT_EXISTS` | 聊天室已存在 |

**注意**: 当前实现中暂不支持服务器主动推送协议，所有通信都是客户端请求-服务器响应模式。

## 数据对象定义

### 聊天对象 (ChatInfo)
```json
{
  "chat_id": "聊天室ID",
  "role": "用户角色",
  "chatname": "聊天室名称"
}
```

### 消息对象 (Message)
```json
{
  "message_id": "消息ID",
  "user_id": "发送者ID",
  "username": "发送者用户名",
  "content": "消息内容",
  "timestamp": "发送时间"
}
```

### 用户对象 (User)
```json
{
  "user_id": "用户ID",
  "username": "用户名",
  "status": "在线状态"
}
```

## 协议使用示例

### 用户注册
**请求:**
```json
{
  "request": "REGISTER",
  "user_id": "user123",
  "username": "张三",
  "password_hash": "hashed_password"
}
```

**响应:**
```json
{
  "request": "REGISTER_RESPONSE",
  "status": "SUCCESS",
  "user_id": "user123",
  "username": "张三"
}
```

### 用户登录
**请求:**
```json
{
  "request": "LOGIN",
  "user_id": "user123",
  "password_hash": "hashed_password"
}
```

**响应:**
```json
{
  "request": "LOGIN_RESPONSE",
  "status": "SUCCESS",
  "user_id": "user123",
  "username": "张三"
}
```

### 发送消息
**请求:**
```json
{
  "request": "MESSAGE",
  "user_id": "user123",
  "chat_id": "chat456",
  "message_id": "msg789",
  "message": "Hello, World!"
}
```

**注意**: 当前实现中，消息发送后服务器会推送给聊天室内的其他在线用户。

## 协议实现说明

### 当前实现状态
- ✅ 用户注册和登录协议已实现
- ✅ 消息发送和推送功能已实现
- ✅ 聊天室管理协议已实现
- ✅ 消息撤回功能已实现
- ⏳ 心跳机制待实现
- ⏳ 消息已读状态功能待实现

### 数据包格式
所有数据包使用 nlohmann/json 库进行序列化和反序列化，通过 TCP Socket 传输。

### 连接管理
- 当前实现中，客户端直接连接服务器，无需额外的连接建立协议
- 每个客户端连接都会创建独立的 Session 对象
- 连接断开时，Session 对象会被销毁，但用户状态可能不会及时更新

### 安全考虑
- 密码以哈希形式传输和存储
- 当前实现中消息内容未加密（待实现AES加密）
- 缺少连接验证和防重放攻击机制
# DuckChat 部署说明

本文档详细说明了 DuckChat 系统的部署配置、环境搭建和运维管理。

**文档版本**: v1.0.0
**最后更新**: 2025-12-25
**维护者**: DuckChat Team

## 系统要求

### 硬件要求

#### 最低配置
- **CPU**: 1核心 1.0GHz
- **内存**: 512MB RAM
- **存储**: 1GB 可用空间
- **网络**: 100Mbps 带宽

#### 推荐配置
- **CPU**: 2核心 2.0GHz+
- **内存**: 2GB+ RAM
- **存储**: 10GB+ SSD
- **网络**: 1Gbps 带宽

#### 生产环境配置
- **CPU**: 4核心 2.5GHz+
- **内存**: 8GB+ RAM
- **存储**: 50GB+ SSD
- **网络**: 1Gbps+ 带宽
- **负载均衡**: 支持多服务器部署

### 软件要求

#### 操作系统
- **Linux**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **Windows**: Windows 10+ (仅支持开发环境)
- **macOS**: macOS 10.15+ (仅支持开发环境)

#### 运行时依赖
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y \
    sqlite3 \
    libsqlite3-dev \
    libncurses5-dev \
    libssl-dev \
    zlib1g-dev

# CentOS/RHEL
sudo yum install -y \
    sqlite \
    sqlite-devel \
    ncurses-devel \
    openssl-devel \
    zlib-devel
```

## 部署方式

### 单机部署

#### 1. 下载和编译
```bash
# 克隆项目
git clone https://github.com/your-org/duckchat.git
cd duckchat

# 编译项目
chmod +x build.sh
./build.sh

# 或手动编译
make all
```

#### 2. 创建部署目录
```bash
# 创建部署目录结构
sudo mkdir -p /opt/duckchat/{bin,config,data,logs,scripts}
sudo chown -R $USER:$USER /opt/duckchat

# 复制可执行文件
cp build/duckchat-server /opt/duckchat/bin/
cp build/duckchat-client /opt/duckchat/bin/

# 复制配置文件
cp config/server.json /opt/duckchat/config/
cp config/client.json /opt/duckchat/config/
```

#### 3. 配置数据库
```bash
# 创建数据目录
mkdir -p /opt/duckchat/data

# 初始化数据库
sqlite3 /opt/duckchat/data/duckchat.db < scripts/init_database.sql

# 设置权限
chmod 600 /opt/duckchat/data/duckchat.db
```

#### 4. 创建启动脚本
```bash
# 服务器启动脚本
cat > /opt/duckchat/scripts/start-server.sh << 'EOF'
#!/bin/bash

# 设置环境变量
export DUCKCHAT_HOME="/opt/duckchat"
export DUCKCHAT_CONFIG="$DUCKCHAT_HOME/config/server.json"
export DUCKCHAT_DATA="$DUCKCHAT_HOME/data"
export DUCKCHAT_LOGS="$DUCKCHAT_HOME/logs"

# 创建日志目录
mkdir -p "$DUCKCHAT_LOGS"

# 启动服务器
cd "$DUCKCHAT_HOME"
./bin/duckchat-server --config="$DUCKCHAT_CONFIG" \
                     --data="$DUCKCHAT_DATA" \
                     --log="$DUCKCHAT_LOGS/server.log"
EOF

chmod +x /opt/duckchat/scripts/start-server.sh
```

#### 5. 创建系统服务
```bash
# 创建systemd服务文件
sudo cat > /etc/systemd/system/duckchat-server.service << 'EOF'
[Unit]
Description=DuckChat Server
After=network.target

[Service]
Type=simple
User=duckchat
Group=duckchat
WorkingDirectory=/opt/duckchat
ExecStart=/opt/duckchat/scripts/start-server.sh
Restart=always
RestartSec=10
Environment=DUCKCHAT_HOME=/opt/duckchat

# 安全设置
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/opt/duckchat/data /opt/duckchat/logs

[Install]
WantedBy=multi-user.target
EOF

# 创建专用用户
sudo useradd -r -s /bin/false -d /opt/duckchat duckchat
sudo chown -R duckchat:duckchat /opt/duckchat

# 启用并启动服务
sudo systemctl daemon-reload
sudo systemctl enable duckchat-server
sudo systemctl start duckchat-server
```

### Docker 部署

#### 1. 创建 Dockerfile
```dockerfile
# Dockerfile
FROM ubuntu:20.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
ENV DUCKCHAT_HOME=/opt/duckchat

# 安装依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    sqlite3 \
    libsqlite3-dev \
    libncurses5-dev \
    libssl-dev \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

# 创建应用目录
WORKDIR $DUCKCHAT_HOME

# 复制源码
COPY . .

# 编译应用
RUN chmod +x build.sh && ./build.sh

# 创建数据目录
RUN mkdir -p data logs config

# 复制配置文件
COPY config/server.json config/
COPY scripts/docker-entrypoint.sh /usr/local/bin/

# 设置权限
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# 暴露端口
EXPOSE 5001

# 设置入口点
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["server"]
```

#### 2. 创建 docker-compose.yml
```yaml
version: '3.8'

services:
  duckchat-server:
    build: .
    container_name: duckchat-server
    ports:
      - "5001:5001"
    volumes:
      - ./data:/opt/duckchat/data
      - ./logs:/opt/duckchat/logs
      - ./config:/opt/duckchat/config
    environment:
      - DUCKCHAT_ENV=production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "5001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  duckchat-client:
    build: .
    container_name: duckchat-client
    depends_on:
      - duckchat-server
    environment:
      - DUCKCHAT_SERVER=duckchat-server:5001
    command: ["client"]
    stdin_open: true
    tty: true
```

#### 3. 部署命令
```bash
# 构建并启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f duckchat-server

# 停止服务
docker-compose down
```

### 云平台部署

#### AWS 部署
```bash
# 使用 AWS CLI 部署到 EC2
aws ec2 run-instances \
    --image-id ami-0c55b159cbfafe1f0 \
    --instance-type t2.micro \
    --key-name my-key-pair \
    --security-group-ids sg-903004f8 \
    --user-data file://cloud-init.sh

# cloud-init.sh 内容
#!/bin/bash
apt-get update
apt-get install -y git build-essential
git clone https://github.com/your-org/duckchat.git
cd duckchat
./deploy.sh
```

#### Kubernetes 部署
```yaml
# k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: duckchat-server
spec:
  replicas: 3
  selector:
    matchLabels:
      app: duckchat-server
  template:
    metadata:
      labels:
        app: duckchat-server
    spec:
      containers:
      - name: duckchat-server
        image: duckchat/server:latest
        ports:
        - containerPort: 5001
        env:
        - name: DUCKCHAT_ENV
          value: "production"
        volumeMounts:
        - name: data-volume
          mountPath: /opt/duckchat/data
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: duckchat-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: duckchat-service
spec:
  selector:
    app: duckchat-server
  ports:
  - protocol: TCP
    port: 5001
    targetPort: 5001
  type: LoadBalancer
```

## 配置管理

### 服务器配置
```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 5001,
    "max_connections": 1000,
    "timeout": 30,
    "keepalive": true
  },
  "database": {
    "type": "sqlite",
    "path": "/opt/duckchat/data/duckchat.db",
    "backup_enabled": true,
    "backup_interval": 3600,
    "max_backups": 10
  },
  "security": {
    "encryption_enabled": true,
    "ssl_cert_path": "/opt/duckchat/config/server.crt",
    "ssl_key_path": "/opt/duckchat/config/server.key",
    "password_hash_rounds": 100000
  },
  "logging": {
    "level": "INFO",
    "file": "/opt/duckchat/logs/server.log",
    "max_size": "100MB",
    "max_files": 5,
    "console": true
  },
  "performance": {
    "thread_pool_size": 4,
    "message_queue_size": 10000,
    "db_connection_pool": 10
  }
}
```

### 客户端配置
```json
{
  "client": {
    "server_host": "localhost",
    "server_port": 5001,
    "auto_reconnect": true,
    "reconnect_interval": 5
  },
  "ui": {
    "theme": "default",
    "font_size": 12,
    "window_width": 80,
    "window_height": 24,
    "show_timestamp": true,
    "show_user_status": true
  },
  "security": {
    "encryption_enabled": true,
    "verify_ssl": true,
    "cache_credentials": false
  },
  "logging": {
    "level": "DEBUG",
    "file": "/opt/duckchat/logs/client.log",
    "max_size": "10MB",
    "max_files": 3
  }
}
```

## 数据库管理

### 初始化脚本
```sql
-- scripts/init_database.sql
PRAGMA foreign_keys = ON;

-- 用户表
CREATE TABLE IF NOT EXISTS users (
    user_id TEXT PRIMARY KEY,
    username TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    salt TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME,
    status TEXT DEFAULT 'offline'
);

-- 聊天室表
CREATE TABLE IF NOT EXISTS chats (
    chat_id TEXT PRIMARY KEY,
    chat_name TEXT NOT NULL,
    creator_id TEXT NOT NULL,
    chat_type TEXT DEFAULT 'group',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (creator_id) REFERENCES users(user_id)
);

-- 聊天室成员表
CREATE TABLE IF NOT EXISTS chat_members (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    role TEXT DEFAULT 'member',
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_read_message_id TEXT,
    is_muted BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (chat_id) REFERENCES chats(chat_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    UNIQUE(chat_id, user_id)
);

-- 消息表
CREATE TABLE IF NOT EXISTS messages (
    message_id TEXT PRIMARY KEY,
    chat_id TEXT NOT NULL,
    sender_id TEXT NOT NULL,
    content TEXT NOT NULL,
    message_type TEXT DEFAULT 'text',
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_recalled BOOLEAN DEFAULT FALSE,
    recalled_at DATETIME,
    recalled_by TEXT,
    edited_at DATETIME,
    edit_count INTEGER DEFAULT 0,
    FOREIGN KEY (chat_id) REFERENCES chats(chat_id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (recalled_by) REFERENCES users(user_id) ON DELETE SET NULL
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_messages_chat_time ON messages(chat_id, sent_at DESC);
CREATE INDEX IF NOT EXISTS idx_chat_members_user ON chat_members(user_id);
CREATE INDEX IF NOT EXISTS idx_chat_members_chat ON chat_members(chat_id);
```

### 备份脚本
```bash
#!/bin/bash
# scripts/backup_database.sh

BACKUP_DIR="/opt/duckchat/backups"
DB_PATH="/opt/duckchat/data/duckchat.db"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/duckchat_backup_$TIMESTAMP.db"

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 执行备份
sqlite3 "$DB_PATH" ".backup $BACKUP_FILE"

# 压缩备份文件
gzip "$BACKUP_FILE"

# 清理旧备份（保留最近10个）
ls -t "$BACKUP_DIR"/duckchat_backup_*.db.gz | tail -n +11 | xargs rm -f

echo "数据库备份完成: $BACKUP_FILE.gz"
```

### 数据迁移脚本
```bash
#!/bin/bash
# scripts/migrate_database.sh

DB_PATH="/opt/duckchat/data/duckchat.db"
MIGRATION_DIR="/opt/duckchat/migrations"

# 检查是否需要迁移
CURRENT_VERSION=$(sqlite3 "$DB_PATH" "PRAGMA user_version;")
echo "当前数据库版本: $CURRENT_VERSION"

# 应用迁移文件
for migration in "$MIGRATION_DIR"/v*.sql; do
    if [ -f "$migration" ]; then
        migration_version=$(basename "$migration" .sql | sed 's/v//')
        
        if [ "$migration_version" -gt "$CURRENT_VERSION" ]; then
            echo "应用迁移: $migration"
            sqlite3 "$DB_PATH" < "$migration"
            sqlite3 "$DB_PATH" "PRAGMA user_version = $migration_version;"
        fi
    fi
done

echo "数据库迁移完成"
```

## 监控和日志

### 日志配置
```cpp
// 配置日志轮转
// /etc/logrotate.d/duckchat
/opt/duckchat/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 duckchat duckchat
    postrotate
        systemctl reload duckchat-server
    endscript
}
```

### 监控脚本
```bash
#!/bin/bash
# scripts/monitor.sh

SERVER_PID=$(pgrep -f duckchat-server)
if [ -z "$SERVER_PID" ]; then
    echo "$(date): DuckChat服务器未运行，尝试重启..."
    systemctl restart duckchat-server
    exit 1
fi

# 检查端口
if ! netstat -tlnp | grep -q ":5001"; then
    echo "$(date): 端口5001未监听，重启服务..."
    systemctl restart duckchat-server
    exit 1
fi

# 检查数据库连接
if ! sqlite3 /opt/duckchat/data/duckchat.db "SELECT 1;" > /dev/null 2>&1; then
    echo "$(date): 数据库连接失败"
    exit 1
fi

echo "$(date): 服务状态正常"
```

### 性能监控
```bash
# 安装监控工具
sudo apt-get install htop iotop nethogs

# 监控脚本
#!/bin/bash
# scripts/performance_monitor.sh

while true; do
    echo "=== $(date) ==="
    echo "CPU使用率:"
    top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//'
    
    echo "内存使用:"
    free -h | grep "Mem:" | awk '{print $3 "/" $2}'
    
    echo "磁盘使用:"
    df -h /opt/duckchat | tail -1 | awk '{print $3 "/" $2 " (" $5 ")"}'
    
    echo "网络连接:"
    netstat -an | grep :5001 | wc -l
    
    echo "------------------------"
    sleep 60
done
```

## 安全配置

### 防火墙设置
```bash
# Ubuntu UFW
sudo ufw allow 22/tcp      # SSH
sudo ufw allow 5001/tcp    # DuckChat
sudo ufw enable

# CentOS firewalld
sudo firewall-cmd --permanent --add-port=5001/tcp
sudo firewall-cmd --reload
```

### SSL/TLS 配置
```bash
# 生成自签名证书
sudo mkdir -p /opt/duckchat/ssl
cd /opt/duckchat/ssl

# 生成私钥
sudo openssl genrsa -out server.key 2048

# 生成证书签名请求
sudo openssl req -new -key server.key -out server.csr

# 生成自签名证书
sudo openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt

# 设置权限
sudo chmod 600 server.key
sudo chmod 644 server.crt
sudo chown duckchat:duckchat *
```

### 访问控制
```bash
# 创建访问控制配置
cat > /opt/duckchat/config/access_control.json << 'EOF'
{
  "ip_whitelist": [
    "127.0.0.1",
    "192.168.1.0/24",
    "10.0.0.0/8"
  ],
  "rate_limiting": {
    "enabled": true,
    "max_requests_per_minute": 60,
    "max_connections_per_ip": 5
  },
  "authentication": {
    "require_ssl": true,
    "session_timeout": 3600
  }
}
EOF
```

## 故障排除

### 常见问题

#### 1. 服务无法启动
```bash
# 检查日志
journalctl -u duckchat-server -f

# 检查配置文件
/opt/duckchat/bin/duckchat-server --check-config

# 检查端口占用
sudo netstat -tlnp | grep 5001
```

#### 2. 数据库连接失败
```bash
# 检查数据库文件权限
ls -la /opt/duckchat/data/duckchat.db

# 测试数据库连接
sqlite3 /opt/duckchat/data/duckchat.db ".tables"

# 检查磁盘空间
df -h /opt/duckchat/data
```

#### 3. 客户端连接超时
```bash
# 检查网络连通性
telnet server_ip 5001

# 检查防火墙设置
sudo ufw status
sudo iptables -L -n

# 检查服务器负载
top -p $(pgrep duckchat-server)
```

### 日志分析
```bash
# 查看错误日志
grep -i error /opt/duckchat/logs/server.log

# 分析连接日志
grep "Client connected" /opt/duckchat/logs/server.log | wc -l

# 监控实时日志
tail -f /opt/duckchat/logs/server.log | grep -i "error\|warning"
```

## 升级和维护

### 版本升级
```bash
#!/bin/bash
# scripts/upgrade.sh

NEW_VERSION=$1
if [ -z "$NEW_VERSION" ]; then
    echo "用法: $0 <新版本号>"
    exit 1
fi

echo "升级到版本: $NEW_VERSION"

# 备份数据库
./scripts/backup_database.sh

# 停止服务
systemctl stop duckchat-server

# 备份当前版本
cp -r /opt/duckchat /opt/duckchat.backup.$(date +%Y%m%d)

# 下载新版本
wget https://releases.duckchat.com/v$NEW_VERSION/duckchat-$NEW_VERSION.tar.gz
tar -xzf duckchat-$NEW_VERSION.tar.gz

# 编译新版本
cd duckchat-$NEW_VERSION
./build.sh

# 替换可执行文件
cp build/duckchat-server /opt/duckchat/bin/
cp build/duckchat-client /opt/duckchat/bin/

# 运行数据库迁移
./scripts/migrate_database.sh

# 启动服务
systemctl start duckchat-server

# 验证升级
sleep 5
systemctl status duckchat-server

echo "升级完成"
```

### 定期维护
```bash
#!/bin/bash
# scripts/maintenance.sh

# 清理日志文件
find /opt/duckchat/logs -name "*.log" -mtime +30 -delete

# 清理临时文件
find /tmp -name "duckchat_*" -mtime +1 -delete

# 优化数据库
sqlite3 /opt/duckchat/data/duckchat.db "VACUUM;"

# 检查磁盘空间
DISK_USAGE=$(df /opt/duckchat | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 80 ]; then
    echo "警告: 磁盘使用率超过80%"
fi

echo "维护任务完成"
```

这个部署说明提供了从开发环境到生产环境的完整部署指南，包括单机部署、Docker容器化、云平台部署等多种方式，以及详细的配置管理、监控和安全配置。